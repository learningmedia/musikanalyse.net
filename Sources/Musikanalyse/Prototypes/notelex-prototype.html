<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Prototype</title>
    <script src="../NoteLex/scripts/jquery-2.0.2.min.js"></script>
    <script src="../NoteLex/scripts/underscore.min.js"></script>
    <script src="../NoteLex/calculationhelper.js"></script>
    <script src="../NoteLex/noteset.js"></script>
    <script src="../NoteLex/pcsettable.js"></script>
    <script src="../piano.js/piano.js"></script>
    <script src="hash.js"></script>
    <script src="http://vexflow.com/vextab/support/vexflow-min.js"></script>
    <link href="../piano.js/styles.css" rel="stylesheet" />
    <style>
        @font-face {
            font-family: 'bebas_neueregular';
            src: url('bebas-neue-fontfacekit/web fonts/bebasneue_regular_macroman/BebasNeue-webfont.eot');
            src: url('bebas-neue-fontfacekit/web fonts/bebasneue_regular_macroman/BebasNeue-webfont.eot?#iefix') format('embedded-opentype'),
                 url('bebas-neue-fontfacekit/web fonts/bebasneue_regular_macroman/BebasNeue-webfont.woff') format('woff'),
                 url('bebas-neue-fontfacekit/web fonts/bebasneue_regular_macroman/BebasNeue-webfont.ttf') format('truetype'),
                 url('bebas-neue-fontfacekit/web fonts/bebasneue_regular_macroman/BebasNeue-webfont.svg#bebas_neueregular') format('svg');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: "Segoe UI", Arial, Helvetica, Verdana, sans-serif;
        }

        #header, #piano, #score, #displayOptions {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }

        #header {
            margin-top: 50px;
            font-size: 96px;
            font-weight: bold;
            font-family: bebas_neueregular;
        }

        #header-note {
            color: steelblue;
        }

        #header-lex {
            color: maroon;
        }

        #nav {
            font-size: 80%;
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
        }

        #nav ul {
            margin: 0;
        }

        #nav li {
            display: inline;
        }

        #score {
            background-color: #fff;
        }

        #results {
            margin: 50px auto 25px auto;
            width: 400px;
        }

        #results > ul {
            list-style-type: none;
            display: table;
            margin: 0;
            padding: 0;
        }

        #results > ul > li {
            display: table-cell;
            padding: 5px;
        }

        #results > ul > li.disabled > a {
            cursor: inherit;
        }

        #results > ul > li > a {
            display: block;
            padding: 5px;
            cursor: pointer;
            color: white;
            width: 50px;
            text-align: center;
        }

        #results > article {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            padding: 10px;
        }
    </style>
</head>
<body>
    <header id="header"><span id="header-note">NOTE</span><span id="header-lex">LEX</span></header>
    <nav id="nav">
        <ul>
            <li><label><input type="radio" name="language" />&nbsp;English</label></li>
            <li><label><input type="radio" name="language" checked="checked" />&nbsp;Deutsch</label></li>
        </ul>
    </nav>
    <div id="score" style="height: 150px; width: 600px;">
        <canvas width="600"></canvas>
    </div>
    <div id="piano" style="height: 150px; width: 600px;"></div>
    <div id="results" style="width: 600px;">
        <ul>
            <li><a style="background-color: steelblue;">MM</a></li>
            <li class="selected" style="background-color: rgba(255, 165, 0, 0.2);"><a style="background-color: rgb(255, 165, 0);">FT</a></li>
            <li><a style="background-color: darkgreen;">AM</a></li>
            <li class="disabled"><a style="background-color: rgb(200, 200, 200); color: grey;">X1</a></li>
            <li><a style="background-color: maroon;">PC</a></li>
            <li class="disabled"><a style="background-color: rgb(200, 200, 200); color: grey;">X2</a></li>
            <li class="disabled"><a style="background-color: rgb(200, 200, 200); color: grey;">X3</a></li>
        </ul>
        <article style="background-color: #ffebc6; background-color: rgba(255, 165, 0, 0.2);">
            <h3>Funktionstheorie</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit fusce vel sapien elit in malesuada semper mi, id sollicitudin urna fermentum ut fusce varius nisl ac ipsum gravida vel pretium tellus.</p>
        </article>
    </div>
    <script>
        $(function () {
            $("#piano").piano({ startKey: 48, endKey: 72, selectionMode: $.fn.piano.selectionMode.MULTIPLE, selectionChangedCallback: onSelectionChanged });

            Hash.addListener(onHashChanged);
            Hash.startListening();

            function onSelectionChanged() {
                var keys = $("#piano").piano().getSelectedKeys();
                Hash.replaceHash(createHashFromKeys(keys));
            }

            function onHashChanged(newHash) {
                var keys = createKeysFromHash(newHash);
                $("#piano").piano().setSelectedKeys(keys);
                var noteSet = new NoteLex.NoteSet(keys);
                drawNoteSet(noteSet);
                showTheory(noteSet, "de");
            }

            function createHashFromKeys(keys) {
                return keys.length != 0 ? JSON.stringify(keys) : "";
            }

            function createKeysFromHash(hash) {
                return hash ? JSON.parse(hash) : [];
            }

            function drawNoteSet(noteSet) {
                var WIDTH = 600;
                var canvas = $("#score canvas")[0];

                var renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.CANVAS);
                var ctx = renderer.getContext();
                ctx.clear();

                var stave = new Vex.Flow.Stave(0, 0, WIDTH - 2); // Subtract 2 to ensure we see the bar line at the end...
                stave.addClef("treble").setContext(ctx).draw();

                // Create the notes
                var notes2 = [
                    new Vex.Flow.StaveNote({ keys: ["c/4", "d/4", "g/4", "b/4"], duration: "w" }),
                    new Vex.Flow.StaveNote({ keys: ["c/4"], duration: "w" }),
                    new Vex.Flow.StaveNote({ keys: ["d/4"], duration: "w" }),
                    new Vex.Flow.StaveNote({ keys: ["g/4"], duration: "w" }),
                    new Vex.Flow.StaveNote({ keys: ["b/4"], duration: "w" })
                ];

                // Create a voice in 4/4
                var voice = new Vex.Flow.Voice({
                    num_beats: 5,
                    beat_value: 1,
                    resolution: Vex.Flow.RESOLUTION
                });

                // Add notes to voice
                voice.addTickables(notes2);

                // Format and justify the notes to 600 pixels
                new Vex.Flow.Formatter().joinVoices([voice]).format([voice], WIDTH);

                // Render voice
                voice.draw(ctx, stave);
            }

            function showTheory(noteSet, language) {
                // Show theories!!!
                var content = getContent(noteSet, language);
                $("#results > article").html(content);
            }

            // This function exists for each theory:
            function getContent(noteSet, language) {
                var tmplHtml = $("#ft-de-template").html();
                var compiled = _.template(tmplHtml);
                var instance = compiled({ name: 'Uli' });

                return instance;
            }
        });
    </script>

    <!-- Templates -->
    <script id="ft-de-template" type="text/template">
        <h3>Funktionstheorie</h3>
        <div>Hallo <%= name %></div>
    </script>
</body>
</html>
